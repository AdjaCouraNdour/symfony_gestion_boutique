{% extends 'base.html.twig' %}

{% block title %}Créer une Dette{% endblock %}

{% block body %}
    <div class="container mx-auto mt-10">
        <h1 class="text-2xl font-bold mb-1">Créer une Dette</h1>

        <!-- Informations du client -->
        <div class="mb-4 p-4 bg-gray-100 rounded shadow">
            <p><strong>Surname :</strong> {{ client.surname }}</p>
            <p><strong>Téléphone :</strong> {{ client.telephone }}</p>
        </div>

        <!-- Section principale : Liste des articles et articles sélectionnés -->
        <div class="flex space-x-6">
            <!-- Tableau des articles à gauche -->
            <div class="w-1/2">
                <h2 class="text-xl font-bold mb-4">Liste des Articles</h2>
                <table class="min-w-full bg-white border border-gray-300 rounded-lg">
                    <thead>
                        <tr class="bg-burgundy text-white">
                            <th class="px-4 text-left py-2">Libellé</th>
                            <th class="px-4 text-left py-2">Prix</th>
                            <th class="px-4 text-left py-2">Stock</th>
                            <th class="px-4 text-left py-2">Cocher</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for article in articles %}
                            <tr class="hover:bg-gray-100">
                                <td class="px-4 py-2">{{ article.libelle }}</td>
                                <td class="px-4 py-2">{{ article.prix }} CFA</td>
                                <td class="px-4 py-2">{{ article.qteStock }}</td>
                                <td class="px-4 py-2 text-center">
                                    <input type="checkbox" onclick="addToSelection('{{ article.libelle }}', {{ article.prix }}, {{ article.id }})">
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Tableau des articles sélectionnés à droite -->
            <div class="w-1/2">
                <h2 class="text-xl font-bold mb-4">Articles Sélectionnés</h2>
                <table id="selectedArticlesTable" class="min-w-full bg-white border border-gray-300 rounded-lg">
                    <thead>
                        <tr class="bg-burgundy text-white">
                            <th class="px-4 py-2">Libellé</th>
                            <th class="px-4 py-2">Quantité</th>
                            <th class="px-4 py-2">Prix</th>
                            <th class="px-4 py-2">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Les articles sélectionnés seront ajoutés ici via JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Bouton Save -->
        <form action="{{ path('dette.save', { clientId: client.id }) }}" method="POST" onsubmit="saveSelection()">
            <input type="hidden" id="selectedArticlesInput" name="selectedArticles">
            <button type="submit" class="bg-burgundy text-white px-4 py-2 rounded hover:bg-red-700 transition duration-200">
                Sauvegarder la Dette
            </button>
        </form>

    </div>
  <script>
    let selectedArticles = [];

    function addToSelection(libelle, prix, id) {
        const tableBody = document.getElementById('selectedArticlesTable').getElementsByTagName('tbody')[0];

        // Vérifier si l'article est déjà sélectionné
        const existingArticleIndex = selectedArticles.findIndex(article => article.id === id);
        if (existingArticleIndex >= 0) {
            // Si l'article est déjà sélectionné et qu'il est décoché, le retirer
            selectedArticles.splice(existingArticleIndex, 1);
            // Retirer la ligne du tableau
            tableBody.deleteRow(existingArticleIndex);
            return;
        }

        const newRow = tableBody.insertRow();

        // Ajouter l'article à la sélection et afficher dans le tableau des articles sélectionnés
        newRow.insertCell(0).textContent = libelle; // Libellé

        const quantityCell = newRow.insertCell(1);
        
        // Créer une div contenant les boutons "moins", "quantité", et "plus"
        const quantityWrapper = document.createElement('div');
        quantityWrapper.classList.add('flex', 'items-center', 'space-x-2'); // Ajouter un espacement

        // Champ de quantité
        const quantityInput = document.createElement('input');
        quantityInput.type = 'number';
        quantityInput.min = 1;
        quantityInput.value = 1; // Valeur par défaut
        quantityInput.classList.add('border', 'px-2', 'py-1', 'w-12', 'text-center'); // Rendre le champ moins large

        quantityWrapper.appendChild(quantityInput);
        // quantityWrapper.appendChild(plusButton);
        quantityCell.appendChild(quantityWrapper);

        // Prix unitaire
        newRow.insertCell(2).textContent = prix.toFixed(2) + ' CFA';

        // Prix total (prix unitaire * quantité)
        const totalCell = newRow.insertCell(3);
        totalCell.textContent = (prix * 1).toFixed(2) + ' CFA'; // Par défaut, quantité = 1

        // Ajouter l'article sélectionné à la liste avec la quantité
        selectedArticles.push({ libelle, prix, id, quantite: 1 });

        // Mettre à jour le prix total quand la quantité change
        quantityInput.addEventListener('input', function () {
            const quantity = parseInt(quantityInput.value);
            totalCell.textContent = (prix * quantity).toFixed(2) + ' CFA';
            updateSelectedArticle(id, quantity);
        });
    }

    function updateQuantity(id, change) {
        const article = selectedArticles.find(article => article.id === id);
        if (article) {
            const index = selectedArticles.indexOf(article);
            const quantityInput = document.getElementById('selectedArticlesTable').rows[index + 1].cells[1].getElementsByTagName('input')[0];
            const newQuantity = article.quantite + change;

            if (newQuantity > 0) {
                article.quantite = newQuantity;
                quantityInput.value = newQuantity; // Mettre à jour l'input de quantité
            } else {
                // Si la quantité devient 0, retirer l'article
                selectedArticles.splice(index, 1);
                document.getElementById('selectedArticlesTable').deleteRow(index + 1);
            }
        }
    }

    function updateSelectedArticle(id, quantity) {
        const article = selectedArticles.find(article => article.id === id);
        if (article) {
            article.quantite = quantity;
        }
    }

    function saveSelection() {
        document.getElementById('selectedArticlesInput').value = JSON.stringify(selectedArticles);
    }
</script>

{% endblock %}
